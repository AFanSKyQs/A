<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{{pluResPath}}style.css">
</head>

<body>
<div id="container" class="{{ data['elem'] }}">
    <div class="TopLeftPanel">
        <div class="UID">{{ data["uid"] }}</div>
        <div class="rank">
            <div class="title">{{ data["rank"] }}</div>
            <div class="dps">{{ data["dps"] }}</div>
            <div class="time">{{ data["tm"] }}</div>
            <div class="total">{{ data["total"] }}</div>
        </div>
        <p>
            <canvas id="canvas_circle" width="350" height="210"
                    style="border: 2px solid #dcdeeb36;margin-top: 80px;margin-left: -10px;">
                浏览器不支持canvas
            </canvas>
        </p>
    </div>
    <div class="Avatars">
        {{each data["avatars"] a}}
        <div class="avatar">
            <!--            <img class="char r{{ a['rarity'] }}" src="./{{ a['name'] }}/{{ a['icon'] }}.png">-->
            <img class="char r{{ a['rarity'] }}" src="{{miaoRes}}meta/character/{{ a['name'] }}/imgs/face-q.webp">
            <div class="char-con c{{ a['cons'] }}"></div>
            <div class="char-lvl">{{ a["level"] }}</div>
            <!--            <img class="weapon r{{ a['weapon']['rarity'] }}" src="./weapon/{{ a['weapon']['icon'] }}.png">-->
            <img class="weapon r{{ a['weapon']['rarity'] }}"
                 src="{{miaoRes}}meta/weapon/{{ a['weapon']['imgPath'] }}/icon.webp">

            <div class="weapon-aff a{{ a['weapon']['affix'] }}"></div>
            <div class="weapon-lvl">{{ a['weapon']['level'] }}</div>
            <div class="arti">
                {{each a["relicSet"] val key}}
                <img class="arti s{{ val }}" src="{{miaoRes}}meta/artifact/imgs/{{ key }}/1.webp" height="100%"
                     width="100%">
                {{/each}}
            </div>
            <div class="detail">
                <div class="cp">{{ a["cp"] }}%</div>
                <div class="cd">{{ a["cd"] }}%</div>
                <div class="prop">
                    <div class="value">{{ a["key_value"] }}</div>
                    <div class="name">{{ a["key_prop"] }}</div>
                </div>
                <div class="recharge">{{ a["recharge"]["pct"] }}</div>
                <div class="same">{{ a["recharge"]["same"] }}</div>
                <div class="diff">{{ a["recharge"]["diff"] }}</div>
                <div class="talent {{ a['elem'] }}">
                    {{each a["skills"] skill}}
                    <div>
                        {{ if skill['icon'].indexOf("_A_") != -1 }}
                        <img src="{{miaoRes}}meta/character/{{ a['name'] }}/icons/talent-a.webp">
                        <span class="{{ skill['style'] }}">{{ skill["level"] }}</span>
                        {{/if}}
                        {{ if skill['icon'].indexOf("_S_") != -1 }}
                        <img src="{{miaoRes}}meta/character/{{ a['name'] }}/icons/talent-e.webp">
                        <span class="{{ skill['style'] }}">{{ skill["level"] }}</span>
                        {{/if}}
                        {{ if skill['icon'].indexOf("_E_") != -1 }}
                        <img src="{{miaoRes}}meta/character/{{ a['name'] }}/icons/talent-q.webp">
                        <span class="{{ skill['style'] }}">{{ skill["level"] }}</span>
                        {{/if}}
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    <div class="Actions">
        <div class="title"></div>
        <div class="act">
            {{each data["actions"] action}}
            <div>{{ action }}</div>
            {{/each}}
        </div>
    </div>
    <ul class="Buffs">
        <li class="title"></li>
        {{each data["buffs"] item}}
        <li class="buff">
            <div>{{ item[0] }}</div>
            <div>{{ item[1] }}</div>
            <div>{{ item[2] }}</div>
        </li>
        {{/each}}
    </ul>
    {{ if detail }}
    <ul class="Damages">
        <li class="title"></li>
        <li class="head">
            <!-- use css to fill this -->
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </li>
        {{each data["damages"] damage}}
        <li class="dmg">
            <div>{{ damage[0] }}</div>
            <div>{{ damage[1] }}</div>
            <div>{{ damage[2] }}</div>
            <div>{{ damage[3] }}</div>
            <div>{{ damage[4] }}</div>
        </li>
        {{/each}}
    </ul>
    {{/if}}
    <div class="copyright">
        FanSky_Qs × Data from Teyvat × Prototype by Nonebot-plugin-gspanel
    </div>
    <!--    <div class="copyright">-->
    <!--        <span style="color: #ffffff; opacity: 0.68; text-shadow: 3px 5px 4px #333333ad; font-size: 20px; width: 960px; text-align: center; padding-top: 60px; padding-bottom: 20px; content: {{dynamicContent}};">Data from Teyvat × Powered by NoneBot2 × Inspired by Miao-Plugin</span>-->
    <!--    </div>-->
</div>
<script>
    function drawCircle(canvasId, data_arr, color_arr, text_arr) {
        const c = document.getElementById(canvasId);
        const ctx = c.getContext("2d");
        const radius = c.height / 2 - 20; //半径
        const ox = radius + 20, oy = radius + 20; //圆心
        const width = 30, height = 10; //图例宽和高
        const posX = ox * 2 + 20, posY = 30;   //
        const textX = posX + width + 5, textY = posY + 10;
        let startAngle = 0; //起始弧度
        let endAngle = 0;   //结束弧度
        for (let i = 0; i < data_arr.length; i++) {//绘制饼图
            endAngle = endAngle + data_arr[i] * Math.PI * 2; //结束弧度
            ctx.fillStyle = color_arr[i];
            ctx.beginPath();
            ctx.moveTo(ox, oy); //移动到到圆心
            ctx.arc(ox, oy, radius, startAngle, endAngle, false);
            ctx.closePath();
            ctx.fill();
            startAngle = endAngle; //设置起始弧度
            ctx.fillStyle = color_arr[i];//绘制比例图及文字
            ctx.fillRect(posX, posY + 20 * i, width, height);
            ctx.moveTo(posX, posY + 20 * i);
            ctx.font = 'bold 12px 微软雅黑';    //斜体 30像素 微软雅黑字体
            ctx.fillStyle = color_arr[i]; //"#000000";
            const percent = text_arr[i] + "：" + 100 * data_arr[i] + "%";
            ctx.fillText(percent, textX, textY + 20 * i);
        }
    }

    async function init() {
        const RoleData = await JSON.parse(`{{data["pie_data"]}}`);
        const RoleColor = await JSON.parse(`{{data["pie_color"]}}`);
        const DamageMap = await RoleData.map((item) => item.damage);
        const total = await DamageMap.reduce((prev, cur) => prev + cur);
        const percent = await DamageMap.map((item) => (item / total).toFixed(4));
        const NameChar = await RoleData.map((item) => item.char);
        console.log(percent);
        console.log(RoleColor);
        console.log(NameChar);
        // const percent = [0.2, 0.3, 0.5];
        // const RoleColor = ["#ff0000", "#00ff00", "#0000ff"];
        // const NameChar = ["角色1", "角色2", "角色3"];
        drawCircle("canvas_circle", percent, RoleColor, NameChar);
    }

    window.onload = init;
</script>
</body>
</html>